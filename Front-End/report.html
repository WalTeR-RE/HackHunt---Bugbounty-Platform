<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Report â€“ HackHunt</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="scripts/auth.js"></script>
  <link rel="icon" href="favicon.ico" />
</head>
<body class="bg-gray-950 text-white">

  <!-- Navbar -->
  <header class="bg-gray-900 shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-purple-500">HackHunt</h1>
      <nav class="space-x-6 hidden md:block">
        <a href="index.html" class="hover:text-purple-400">Home</a>
        <a href="dashboard.html" class="hover:text-purple-400">Dashboard</a>
        <a href="logout.html" class="bg-purple-600 px-4 py-2 rounded-xl hover:bg-purple-700 transition">Logout</a>
      </nav>
    </div>
  </header>

  <!-- Report Details -->
  <section class="max-w-4xl mx-auto px-6 py-12 space-y-6">
    <h2 class="text-3xl font-bold text-purple-500 text-center">Report Details</h2>
    <div id="reportDetails" class="bg-gray-900 p-6 rounded-xl shadow-lg space-y-4">
      <!-- Dynamic content inserted via JS -->
    </div>

    <!-- Comments Section -->
    <div class="bg-gray-900 p-6 rounded-xl shadow-lg space-y-4">
      <h3 class="text-2xl font-bold text-purple-400">Comments</h3>
      <div id="commentsList" class="space-y-4">
        <!-- Comments dynamically inserted -->
      </div>

      <form id="commentForm" class="space-y-4">
        <textarea id="commentText" placeholder="Write your comment..." required class="w-full p-3 bg-gray-800 rounded-lg h-24 resize-none focus:outline-none"></textarea>
        <div id="moderatorOptions" class="space-x-4 hidden">
          <label><input type="checkbox" id="internalComment" class="mr-2">Internal</label>
          <div id="rewardSection" class="space-x-2">
            <input type="number" id="points" placeholder="Points" class="p-2 rounded bg-gray-800 w-24">
            <input type="number" id="bounty" placeholder="Bounty $" class="p-2 rounded bg-gray-800 w-32">
            <button id="rewardBtn" type="button" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700 transition">Reward</button>
          </div>
        </div>
        <button type="submit" class="bg-purple-600 px-4 py-2 rounded hover:bg-purple-700 transition">Add Comment</button>
      </form>
    </div>
  </section>

  <footer class="bg-gray-900 text-center py-6 text-gray-500">
    &copy; 2025 HackHunt. All rights reserved.
  </footer>

  <script>
    let user = null;
    let alreadyRewarded = false;

    document.addEventListener("DOMContentLoaded", async function () {
      user = await authenticated();
      if (!user) return (window.location.href = "Login.html");

      const roleId = user.role_id;
      const urlParams = new URLSearchParams(window.location.search);
      const reportId = urlParams.get("uuid");

      // Show moderator options if role_id >= 2
      if (roleId >= 2) {
        document.getElementById("moderatorOptions").classList.remove("hidden");
      }

      // Fetch report data
      try {
        const token = localStorage.getItem("token");
        const res = await fetch(`http://127.0.0.1:8000/api/reports/${reportId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const report = await res.json();

        if (!res.ok) throw new Error("Report fetch failed");

        // Render report
        const container = document.getElementById("reportDetails");
        container.innerHTML = `
          <h3 class="text-xl font-semibold">Title: ${report.title}</h3>
          <p><strong>Type:</strong> ${report.type}</p>
          <p><strong>Description:</strong><br>${report.description}</p>
          <p><strong>Severity:</strong> ${report.severity}</p>
          <div><strong>Attachments:</strong><br>
            ${report.attachments.map(file =>
              `<a class="text-blue-400 underline" href="/files/${file}" target="_blank">${file}</a>`
            ).join("<br>")}
          </div>
        `;

        alreadyRewarded = report.rewarded;

        if (alreadyRewarded) {
          document.getElementById("rewardSection").classList.add("hidden");
        }

        // Load comments
        loadComments(reportId);

      } catch (err) {
        alert("Failed to load report.");
        console.error(err);
      }
    });

    async function loadComments(reportId) {
      const token = localStorage.getItem("token");
      const res = await fetch(`http://127.0.0.1:8000/api/reports/${reportId}/comments`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const comments = await res.json();
      const list = document.getElementById("commentsList");
      list.innerHTML = comments.map(c =>
        `<div class="bg-gray-800 p-4 rounded-lg">
          <p>${c.internal ? "<strong>[Internal]</strong> " : ""}${c.text}</p>
          <small class="text-gray-400">By ${c.user_name}</small>
        </div>`
      ).join("");
    }

    // Submit comment
    document.getElementById("commentForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const reportId = new URLSearchParams(window.location.search).get("uuid");
      const token = localStorage.getItem("token");
      const text = document.getElementById("commentText").value;
      const internal = document.getElementById("internalComment").checked;

      const res = await fetch(`http://127.0.0.1:8000/api/reports/${reportId}/comments`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ text, internal })
      });

      if (res.ok) {
        document.getElementById("commentText").value = "";
        loadComments(reportId);
      } else {
        alert("Failed to add comment.");
      }
    });

    // Reward logic
    document.getElementById("rewardBtn").addEventListener("click", async function () {
      const reportId = new URLSearchParams(window.location.search).get("uuid");
      const token = localStorage.getItem("token");
      const points = document.getElementById("points").value;
      const bounty = document.getElementById("bounty").value;

      const res = await fetch(`http://127.0.0.1:8000/api/reports/${reportId}/reward`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ points, bounty })
      });

      if (res.ok) {
        alert("Reward granted.");
        document.getElementById("rewardSection").classList.add("hidden");
        alreadyRewarded = true;
      } else {
        alert("Reward failed.");
      }
    });
  </script>
</body>
</html>